import { expect, test } from "bun:test";
import {Sniffer} from "../sniffer.ts";
import {initializeLowerApiConsoleForTest} from "../lower-api-console.ts";
import {parseCtData} from "./ct.ts";

const testDataForExampleCom = [ { "id":"9218060291", "tbs_sha256":"0338ad6e03b98fd5bf2828e2abfbf2c2fa74cf408834f9b6a343fbe2b4c0705a", "cert_sha256":"10033731d50e757a2566927392d64734959925b4f9a814374f48b9bcc8dc41b8", "dns_names":["example.com","example.edu","example.net","example.org","www.example.com","www.example.edu","www.example.net","www.example.org"], "pubkey_sha256":"2f49fea71f7262736e045777a12014f0f84a83792eb7bc9277845c29f2ffc001", "issuer":{"friendly_name":"DigiCert","caa_domains":["www.digicert.com","digicert.com","digicert.ne.jp","cybertrust.ne.jp","thawte.com","geotrust.com","rapidssl.com","symantec.com","volusion.digitalcertvalidation.com","stratossl.digitalcertvalidation.com","intermediatecertificate.digitalcertvalidation.com","1and1.digitalcertvalidation.com","amazon.com","amazontrust.com","awstrust.com","amazonaws.com","digitalcertvalidation.com","quovadisglobal.com"],"pubkey_sha256":"59e738e674221702af1edb87c5200c1a4b75f64fae3d2c3d265124c61bd83c79","name":"C=US, O=DigiCert Inc, CN=DigiCert Global G2 TLS RSA SHA256 2020 CA1"}, "not_before":"2025-01-14T00:00:00Z", "not_after":"2026-02-14T23:59:59Z", "revoked":false }, { "id":"9219290871", "tbs_sha256":"bc8ace8a15de0d8136c6f642e1d1e367a3dd38d5534e3fc4f52c5ee6b86cb25d", "cert_sha256":"455943cf819425761d1f950263ebf54755d8d684c25535943976f488bc79d23b", "dns_names":["*.example.com","example.com"], "pubkey_sha256":"88c3292097527f95650a51dac5945eca168bc4bb2664c30d022036a4c47cfcce", "issuer":{"friendly_name":"DigiCert","caa_domains":["www.digicert.com","digicert.com","digicert.ne.jp","cybertrust.ne.jp","thawte.com","geotrust.com","rapidssl.com","symantec.com","volusion.digitalcertvalidation.com","stratossl.digitalcertvalidation.com","intermediatecertificate.digitalcertvalidation.com","1and1.digitalcertvalidation.com","amazon.com","amazontrust.com","awstrust.com","amazonaws.com","digitalcertvalidation.com","quovadisglobal.com"],"pubkey_sha256":"a814636663a69123492f4a7bd337a4ee8752233aacfe6b91e0993dc58c823fe1","name":"C=US, O=DigiCert Inc, CN=DigiCert Global G3 TLS ECC SHA384 2020 CA1"}, "not_before":"2025-01-15T00:00:00Z", "not_after":"2026-01-15T23:59:59Z", "revoked":false }, { "id":"9439357927", "tbs_sha256":"f3dfd226e15d7701d44144d36986f15d5d711eedaee9c7bbcc0ee2cd9b34f3c0", "cert_sha256":"388ec9c1fb34df18b0bcb98601ca41e43dfc36db64927aa9f28552378a87f493", "dns_names":["*.example.com","example.com"], "pubkey_sha256":"88c3292097527f95650a51dac5945eca168bc4bb2664c30d022036a4c47cfcce", "issuer":{"friendly_name":"Sectigo","caa_domains":["sectigo.com","comodo.com","comodoca.com","usertrust.com","trust-provider.com","entrust.net","affirmtrust.com"],"pubkey_sha256":"36874480b45d52d8ff0a6e4b750173afa04838d85b5e5cdc57b340a8ca3cefd5","name":"C=GB, ST=Greater Manchester, L=Salford, O=Sectigo Limited, CN=Sectigo ECC Organization Validation Secure Server CA"}, "not_before":"2025-02-07T00:00:00Z", "not_after":"2026-03-10T23:59:59Z", "revoked":true }];
const sniffer = new Sniffer(initializeLowerApiConsoleForTest());

test('parseCtData test with example.com', () => {
    const parsed = parseCtData(sniffer, [testDataForExampleCom]);

    expect(parsed).toBeArrayOfSize(10);
    expect(parsed).toEqual(["example.com", "example.edu", "example.net", "example.org", "www.example.com", "www.example.edu", "www.example.net", "www.example.org", "example.com", "example.com"]);
});
