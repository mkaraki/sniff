import { expect, test } from "bun:test";
import {parseRdapObject} from "./rdap.ts";
import {Sniffer} from "../sniffer.ts";
import {initializeLowerApiConsoleForTest} from "../lower-api-console.ts";

const test1_1_1_1RdapObject = {"rdapConformance":["history_version_0","nro_rdap_profile_0","cidr0","rdap_level_0"],"notices":[{"title":"Source","description":["Objects returned came from source","APNIC"]},{"title":"Terms and Conditions","description":["This is the APNIC WHOIS Database query service. The objects are in RDAP format."],"links":[{"value":"https://rdap.apnic.net/ip/1.1.1.1","rel":"terms-of-service","href":"http://www.apnic.net/db/dbcopyright.html","type":"text/html"}]},{"title":"Whois Inaccuracy Reporting","description":["If you see inaccuracies in the results, please visit: "],"links":[{"value":"https://rdap.apnic.net/ip/1.1.1.1","rel":"inaccuracy-report","href":"https://www.apnic.net/manage-ip/using-whois/abuse-and-spamming/invalid-contact-form","type":"text/html"}]}],"country":"AU","events":[{"eventAction":"registration","eventDate":"2011-08-10T23:12:35Z"},{"eventAction":"last changed","eventDate":"2023-04-26T22:57:58Z"}],"name":"APNIC-LABS","remarks":[{"description":["APNIC and Cloudflare DNS Resolver project","Routed globally by AS13335/Cloudflare","Research prefix for APNIC Labs"],"title":"description"},{"description":["---------------","All Cloudflare abuse reporting can be done via","resolver-abuse@cloudflare.com","---------------"],"title":"remarks"}],"links":[{"value":"https://rdap.apnic.net/ip/1.1.1.1","rel":"self","href":"https://rdap.apnic.net/ip/1.1.1.0/24","type":"application/rdap+json"}],"status":["active"],"type":"ASSIGNED PORTABLE","ipVersion":"v4","endAddress":"1.1.1.255","startAddress":"1.1.1.0","objectClassName":"ip network","handle":"1.1.1.0 - 1.1.1.255","entities":[{"roles":["registrant"],"events":[{"eventAction":"registration","eventDate":"2017-08-08T23:21:55Z"},{"eventAction":"last changed","eventDate":"2023-09-05T02:15:19Z"}],"links":[{"value":"https://rdap.apnic.net/ip/1.1.1.1","rel":"self","href":"https://rdap.apnic.net/entity/ORG-ARAD1-AP","type":"application/rdap+json"}],"vcardArray":["vcard",[["version",{},"text","4.0"],["fn",{},"text","APNIC Research and Development"],["kind",{},"text","org"],["adr",{"label":"6 Cordelia St"},"text",["","","","","","",""]],["tel",{"type":"voice"},"text","+61-7-38583100"],["tel",{"type":"fax"},"text","+61-7-38583199"],["email",{},"text","helpdesk@apnic.net"]]],"objectClassName":"entity","handle":"ORG-ARAD1-AP"},{"roles":["abuse"],"events":[{"eventAction":"registration","eventDate":"2011-04-12T17:56:54Z"},{"eventAction":"last changed","eventDate":"2025-11-18T00:26:57Z"}],"remarks":[{"description":["helpdesk@apnic.net was validated on 2021-02-09"],"title":"remarks"}],"links":[{"value":"https://rdap.apnic.net/ip/1.1.1.1","rel":"self","href":"https://rdap.apnic.net/entity/IRT-APNICRANDNET-AU","type":"application/rdap+json"}],"vcardArray":["vcard",[["version",{},"text","4.0"],["fn",{},"text","IRT-APNICRANDNET-AU"],["kind",{},"text","group"],["adr",{"label":"PO Box 3646\nSouth Brisbane, QLD 4101\nAustralia"},"text",["","","","","","",""]],["email",{},"text","helpdesk@apnic.net"],["email",{"pref":"1"},"text","helpdesk@apnic.net"]]],"objectClassName":"entity","handle":"IRT-APNICRANDNET-AU"},{"roles":["administrative","technical"],"events":[{"eventAction":"registration","eventDate":"2023-04-26T00:42:16Z"},{"eventAction":"last changed","eventDate":"2024-07-18T04:37:37Z"}],"links":[{"value":"https://rdap.apnic.net/ip/1.1.1.1","rel":"self","href":"https://rdap.apnic.net/entity/AIC3-AP","type":"application/rdap+json"}],"vcardArray":["vcard",[["version",{},"text","4.0"],["fn",{},"text","APNICRANDNET Infrastructure Contact"],["kind",{},"text","group"],["adr",{"label":"6 Cordelia St South Brisbane QLD 4101"},"text",["","","","","","",""]],["tel",{"type":"voice"},"text","+61 7 3858 3100"],["email",{},"text","research@apnic.net"]]],"objectClassName":"entity","handle":"AIC3-AP"}],"cidr0_cidrs":[{"v4prefix":"1.1.1.0","length":24}],"port43":"whois.apnic.net"};
const sniffer = new Sniffer(initializeLowerApiConsoleForTest());

test("parseRdapObject IP rdap test (1.1.1.1)", () => {
    const found = parseRdapObject(sniffer, test1_1_1_1RdapObject);
    expect(found).toBeArrayOfSize(4);
    expect(found).toEqual(['apnic.net', 'apnic.net', 'apnic.net', 'apnic.net']);
});